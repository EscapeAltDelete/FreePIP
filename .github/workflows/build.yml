name: Build FreePIP Rootless

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Rootless
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          submodules: recursive

      - name: Download iOS Toolchain
        run: |
          # Create toolchain directory
          mkdir -p theos/toolchain/linux/iphone
          
          # Download L1ghtmann's Toolchain (Correct URL)
          # This toolchain supports iOS 14+ SDKs and is built for Linux x86_64
          curl -L -o toolchain.tar.xz https://github.com/L1ghtmann/llvm-project/releases/latest/download/iOSToolchain.tar.xz
          
          # Extract it
          tar -xf toolchain.tar.xz -C theos/toolchain/linux/iphone --strip-components=1
          rm toolchain.tar.xz

      - name: Download iOS 16.5 SDK
        run: |
          mkdir -p theos/sdks
          # Sparse checkout to save time/bandwidth
          git clone --depth 1 --filter=blob:none --sparse https://github.com/theos/sdks.git sdk_tmp
          cd sdk_tmp
          git sparse-checkout set iPhoneOS16.5.sdk
          mv iPhoneOS16.5.sdk ../theos/sdks/
          cd ..
          rm -rf sdk_tmp

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make perl xz-utils

      - name: Build Package
        run: |
          export THEOS=$PWD/theos
          make clean
          # Build strictly for rootless
          make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FreePIP-Rootless-iOS17
          path: packages/*.deb